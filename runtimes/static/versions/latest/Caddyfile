:3000 {
	root * /usr/local/server/src/function

	@auth expression `{env.AUTH} != "disabled"`
	basic_auth @auth {
		opr {env.AUTH}
	}

	# Hide hidden files
	@hidden path */.*
	respond @hidden 404

	# Telemetry endpoint
	@telemetry header X-Open-Runtimes-Timings *
	handle @telemetry {
		root * /usr/local/telemetry
		rewrite * /timings.txt
		# Convert any method to GET so file_server can handle it
		method * GET
		file_server
	}

	# No cache headers
	header Cache-Control "no-cache"

	# Handle directories with trailing slash redirect
	@directory {
		file {path}/
		not path */
	}
	redir @directory {path}/ 308

	# SPA fallback with clean URLs
	try_files {path} {path}.html {path}/index.html {env.PAGE_FALLBACK}

	# Error handling
	handle_errors {
		@404 expression {http.error.status_code} == 404
		rewrite @404 /404.html
		root @404 /mnt/resources
		file_server @404

		@401 expression {http.error.status_code} == 401
		respond @401 "Unauthorized" 401
	}

	file_server
}
